---
import Layout from '../layouts/Layout.astro';

// This page can be static (prerendered)
export const prerender = true;
---

<Layout title="Submit a Glass Store - Molten">
  <section class="py-16 bg-gray-50 min-h-screen">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl font-bold mb-4">Submit a Glass Store</h1>
        <p class="text-lg text-gray-600">
          Know a great glass supply store? Share it with the Molten community!
        </p>
        <p class="text-sm text-gray-500 mt-2">
          All submissions are reviewed before being added to the app.
        </p>
      </div>

      <!-- Form -->
      <div class="bg-white rounded-lg shadow-lg p-8">
        <form id="storeSubmissionForm" class="space-y-6">
          <!-- Store Name -->
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
              Store Name <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="name"
              name="name"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              placeholder="e.g., Frantz Art Glass"
            />
          </div>

          <!-- Address Line 1 with Autocomplete -->
          <div class="relative">
            <label for="address_line1" class="block text-sm font-medium text-gray-700 mb-2">
              Address <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="address_line1"
              name="address_line1"
              required
              autocomplete="off"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              placeholder="Start typing address..."
            />
            <!-- Autocomplete dropdown -->
            <div id="addressAutocomplete" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
              <!-- Suggestions will be populated here -->
            </div>
          </div>

          <!-- Address Line 2 (Optional) -->
          <div>
            <label for="address_line2" class="block text-sm font-medium text-gray-700 mb-2">
              Address Line 2 <span class="text-gray-400">(Optional)</span>
            </label>
            <input
              type="text"
              id="address_line2"
              name="address_line2"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              placeholder="Suite 100"
            />
          </div>

          <!-- City, State, ZIP Row -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
              <label for="city" class="block text-sm font-medium text-gray-700 mb-2">
                City <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="city"
                name="city"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                placeholder="Seattle"
              />
            </div>

            <div>
              <label for="state" class="block text-sm font-medium text-gray-700 mb-2">
                State <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="state"
                name="state"
                required
                maxlength="2"
                pattern="[A-Z]{2}"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent uppercase"
                placeholder="WA"
              />
            </div>
          </div>

          <div>
            <label for="zip" class="block text-sm font-medium text-gray-700 mb-2">
              ZIP Code <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="zip"
              name="zip"
              required
              pattern="[0-9]{5}(-[0-9]{4})?"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              placeholder="98119"
            />
          </div>

          <!-- Phone -->
          <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
              Phone Number <span class="text-gray-400">(Optional)</span>
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              placeholder="(206) 284-5600"
            />
          </div>

          <!-- Website -->
          <div>
            <label for="website_url" class="block text-sm font-medium text-gray-700 mb-2">
              Website <span class="text-red-500">*</span>
            </label>
            <input
              type="url"
              id="website_url"
              name="website_url"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              placeholder="https://example.com"
            />
          </div>

          <!-- Notes -->
          <div>
            <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
              Notes <span class="text-gray-400">(Optional)</span>
            </label>
            <textarea
              id="notes"
              name="notes"
              rows="3"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              placeholder="Any additional information about this store..."
            ></textarea>
          </div>

          <!-- Techniques Supported -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-3">
              Techniques Supported <span class="text-gray-400">(Optional - select all that apply)</span>
            </label>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="checkbox" name="supports_casting" class="w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                <span class="ml-2 text-gray-700">Casting</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="supports_flameworking_hard" class="w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                <span class="ml-2 text-gray-700">Flameworking - Hard (Borosilicate)</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="supports_flameworking_soft" class="w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                <span class="ml-2 text-gray-700">Flameworking - Soft (Soda-Lime)</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="supports_fusing" class="w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                <span class="ml-2 text-gray-700">Fusing</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="supports_glass_blowing" class="w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                <span class="ml-2 text-gray-700">Glass Blowing</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="supports_stained_glass" class="w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                <span class="ml-2 text-gray-700">Stained Glass</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="supports_other" class="w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                <span class="ml-2 text-gray-700">Other</span>
              </label>
            </div>
          </div>

          <!-- Submitter Info -->
          <div class="border-t pt-6 mt-6">
            <h3 class="text-lg font-medium mb-4">Your Information (Optional)</h3>
            <p class="text-sm text-gray-600 mb-4">
              We won't share your information. It's just so we can follow up if needed.
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="submitter_name" class="block text-sm font-medium text-gray-700 mb-2">
                  Your Name
                </label>
                <input
                  type="text"
                  id="submitter_name"
                  name="submitter_name"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                />
              </div>

              <div>
                <label for="submitter_email" class="block text-sm font-medium text-gray-700 mb-2">
                  Your Email
                </label>
                <input
                  type="email"
                  id="submitter_email"
                  name="submitter_email"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                />
              </div>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="pt-6">
            <button
              type="submit"
              class="w-full bg-orange-500 text-white py-3 px-6 rounded-lg font-bold text-lg hover:bg-orange-600 transition disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Submit Store
            </button>
          </div>

          <!-- Success/Error Messages -->
          <div id="formMessage" class="hidden p-4 rounded-lg"></div>
        </form>
      </div>

      <!-- Back Link -->
      <div class="text-center mt-8">
        <a href="/" class="text-orange-500 hover:text-orange-600 font-medium">
          ← Back to Home
        </a>
      </div>
    </div>
  </section>
</Layout>

<script>
  const form = document.getElementById('storeSubmissionForm') as HTMLFormElement;
  const messageDiv = document.getElementById('formMessage') as HTMLDivElement;

  // State name to abbreviation mapping
  const stateAbbreviations: Record<string, string> = {
    'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
    'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
    'Hawaii': 'HI', 'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA',
    'Kansas': 'KS', 'Kentucky': 'KY', 'Louisiana': 'LA', 'Maine': 'ME', 'Maryland': 'MD',
    'Massachusetts': 'MA', 'Michigan': 'MI', 'Minnesota': 'MN', 'Mississippi': 'MS', 'Missouri': 'MO',
    'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Hampshire': 'NH', 'New Jersey': 'NJ',
    'New Mexico': 'NM', 'New York': 'NY', 'North Carolina': 'NC', 'North Dakota': 'ND', 'Ohio': 'OH',
    'Oklahoma': 'OK', 'Oregon': 'OR', 'Pennsylvania': 'PA', 'Rhode Island': 'RI', 'South Carolina': 'SC',
    'South Dakota': 'SD', 'Tennessee': 'TN', 'Texas': 'TX', 'Utah': 'UT', 'Vermont': 'VT',
    'Virginia': 'VA', 'Washington': 'WA', 'West Virginia': 'WV', 'Wisconsin': 'WI', 'Wyoming': 'WY'
  };

  // Address autocomplete using Photon (OpenStreetMap)
  const addressInput = document.getElementById('address_line1') as HTMLInputElement;
  const autocompleteDiv = document.getElementById('addressAutocomplete') as HTMLDivElement;
  let autocompleteTimeout: ReturnType<typeof setTimeout>;

  addressInput?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value;

    // Clear previous timeout
    clearTimeout(autocompleteTimeout);

    // Hide autocomplete if query is too short
    if (query.length < 3) {
      autocompleteDiv.classList.add('hidden');
      return;
    }

    // Debounce API calls (wait 300ms after user stops typing)
    autocompleteTimeout = setTimeout(async () => {
      try {
        // Call Photon API (OpenStreetMap autocomplete)
        // Note: Photon doesn't support countrycodes parameter, using bbox for US instead
        const response = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=5&layer=address`);

        if (!response.ok) {
          console.error('Photon API error:', response.status, response.statusText);
          autocompleteDiv.classList.add('hidden');
          return;
        }

        const data = await response.json();
        console.log('Photon API response:', data);

        if (data.features && data.features.length > 0) {
          // Show suggestions
          autocompleteDiv.innerHTML = data.features.map((feature: any) => {
            const props = feature.properties;
            const name = props.name || '';
            const street = props.street || '';
            const housenumber = props.housenumber || '';
            const city = props.city || '';
            const state = props.state || '';
            const postcode = props.postcode || '';

            // Build display text
            let displayText = '';
            if (housenumber && street) {
              displayText = `${housenumber} ${street}`;
            } else if (street) {
              displayText = street;
            } else if (name) {
              displayText = name;
            }

            if (city) displayText += `, ${city}`;
            if (state) displayText += `, ${state}`;
            if (postcode) displayText += ` ${postcode}`;

            return `
              <button
                type="button"
                class="w-full text-left px-4 py-2 hover:bg-gray-100 focus:bg-gray-100 focus:outline-none"
                data-street="${street || name}"
                data-housenumber="${housenumber}"
                data-city="${city}"
                data-state="${state}"
                data-postcode="${postcode}"
              >
                <div class="text-sm font-medium">${displayText}</div>
              </button>
            `;
          }).join('');

          // Add click handlers to suggestions
          autocompleteDiv.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
              const street = btn.getAttribute('data-street') || '';
              const housenumber = btn.getAttribute('data-housenumber') || '';
              const city = btn.getAttribute('data-city') || '';
              const state = btn.getAttribute('data-state') || '';
              const postcode = btn.getAttribute('data-postcode') || '';

              // Fill in form fields
              const addressLine1 = housenumber && street ? `${housenumber} ${street}` : street;
              (document.getElementById('address_line1') as HTMLInputElement).value = addressLine1;
              (document.getElementById('city') as HTMLInputElement).value = city;

              // Convert state name to abbreviation
              const stateAbbr = stateAbbreviations[state] || state.substring(0, 2).toUpperCase();
              (document.getElementById('state') as HTMLInputElement).value = stateAbbr;

              (document.getElementById('zip') as HTMLInputElement).value = postcode;

              // Hide autocomplete
              autocompleteDiv.classList.add('hidden');
            });
          });

          autocompleteDiv.classList.remove('hidden');
        } else {
          autocompleteDiv.classList.add('hidden');
        }
      } catch (error) {
        console.error('Autocomplete error:', error);
        autocompleteDiv.classList.add('hidden');
      }
    }, 300);
  });

  // Hide autocomplete when clicking outside
  document.addEventListener('click', (e) => {
    if (!addressInput?.contains(e.target as Node) && !autocompleteDiv?.contains(e.target as Node)) {
      autocompleteDiv?.classList.add('hidden');
    }
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Get form data
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Handle checkboxes explicitly (FormData only includes checked boxes)
    const techniqueFields = [
      'supports_casting',
      'supports_flameworking_hard',
      'supports_flameworking_soft',
      'supports_fusing',
      'supports_glass_blowing',
      'supports_stained_glass',
      'supports_other'
    ];
    techniqueFields.forEach(field => {
      data[field] = formData.has(field);
    });

    // Disable submit button
    const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    submitButton.disabled = true;
    submitButton.textContent = 'Submitting...';

    try {
      const response = await fetch('/api/submit-store', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (response.ok) {
        // Success
        messageDiv.className = 'p-4 rounded-lg bg-green-50 border border-green-200 text-green-800';
        messageDiv.textContent = result.message || 'Thank you! Your submission has been received and will be reviewed shortly.';
        messageDiv.classList.remove('hidden');

        // Reset form
        form.reset();
      } else {
        // Error
        messageDiv.className = 'p-4 rounded-lg bg-red-50 border border-red-200 text-red-800';
        messageDiv.textContent = result.error || 'Something went wrong. Please try again.';
        messageDiv.classList.remove('hidden');
      }
    } catch (error) {
      messageDiv.className = 'p-4 rounded-lg bg-red-50 border border-red-200 text-red-800';
      messageDiv.textContent = 'Network error. Please check your connection and try again.';
      messageDiv.classList.remove('hidden');
    } finally {
      // Re-enable submit button
      submitButton.disabled = false;
      submitButton.textContent = 'Submit Store';

      // Scroll to message
      messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  });
</script>
