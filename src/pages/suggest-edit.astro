---
import Layout from '../layouts/Layout.astro';

// This page can be static (prerendered)
export const prerender = true;
---

<Layout title="Suggest Store Edit - Molten">
  <section class="py-16 bg-gray-50 min-h-screen">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl font-bold mb-4">Suggest a Store Edit</h1>
        <p class="text-lg text-gray-600">
          Found outdated or incorrect information? Help us keep store data accurate!
        </p>
        <p class="text-sm text-gray-500 mt-2">
          All suggestions are reviewed before being applied.
        </p>
      </div>

      <!-- Store Selection -->
      <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
        <div class="mb-6">
          <label for="storeSearch" class="block text-sm font-medium text-gray-700 mb-2">
            Find Store <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="storeSearch"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
            placeholder="Start typing store name..."
          />
        </div>

        <!-- Search results -->
        <div id="searchResults" class="hidden space-y-2 max-h-60 overflow-y-auto">
          <!-- Results will be populated here -->
        </div>
      </div>

      <!-- Edit Form (hidden until store selected) -->
      <div id="editFormContainer" class="hidden bg-white rounded-lg shadow-lg p-8">
        <h2 class="text-2xl font-bold mb-4">Current Store Information</h2>
        <p class="text-sm text-gray-600 mb-6">
          Fields below show the current information. Update any fields that need correction.
        </p>

        <form id="editSuggestionForm" class="space-y-6">
          <input type="hidden" id="store_stable_id" name="store_stable_id" />
          <input type="hidden" id="original_name" name="original_name" />

          <!-- Store Name -->
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
              Store Name <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="name"
              name="name"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
            />
          </div>

          <!-- Website -->
          <div>
            <label for="website_url" class="block text-sm font-medium text-gray-700 mb-2">
              Website <span class="text-red-500">*</span>
            </label>
            <input
              type="url"
              id="website_url"
              name="website_url"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
            />
          </div>

          <!-- Address Line 1 -->
          <div>
            <label for="address_line1" class="block text-sm font-medium text-gray-700 mb-2">
              Address <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="address_line1"
              name="address_line1"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
            />
          </div>

          <!-- Address Line 2 -->
          <div>
            <label for="address_line2" class="block text-sm font-medium text-gray-700 mb-2">
              Address Line 2 <span class="text-gray-400">(Optional)</span>
            </label>
            <input
              type="text"
              id="address_line2"
              name="address_line2"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
            />
          </div>

          <!-- City, State, ZIP Row -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
              <label for="city" class="block text-sm font-medium text-gray-700 mb-2">
                City <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="city"
                name="city"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              />
            </div>

            <div>
              <label for="state" class="block text-sm font-medium text-gray-700 mb-2">
                State <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="state"
                name="state"
                required
                maxlength="2"
                pattern="[A-Z]{2}"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent uppercase"
              />
            </div>
          </div>

          <div>
            <label for="zip" class="block text-sm font-medium text-gray-700 mb-2">
              ZIP Code <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="zip"
              name="zip"
              required
              pattern="[0-9]{5}(-[0-9]{4})?"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
            />
          </div>

          <!-- Phone -->
          <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
              Phone Number <span class="text-gray-400">(Optional)</span>
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
            />
          </div>

          <!-- Notes -->
          <div>
            <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
              Notes <span class="text-gray-400">(Optional)</span>
            </label>
            <textarea
              id="notes"
              name="notes"
              rows="3"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
            ></textarea>
          </div>

          <!-- Techniques Supported -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-3">
              Techniques Supported <span class="text-gray-400">(Optional - select all that apply)</span>
            </label>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="checkbox" name="supports_casting" class="w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                <span class="ml-2 text-gray-700">Casting</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="supports_flameworking_hard" class="w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                <span class="ml-2 text-gray-700">Flameworking - Hard (Borosilicate)</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="supports_flameworking_soft" class="w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                <span class="ml-2 text-gray-700">Flameworking - Soft (Soda-Lime)</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="supports_fusing" class="w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                <span class="ml-2 text-gray-700">Fusing</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="supports_glass_blowing" class="w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                <span class="ml-2 text-gray-700">Glass Blowing</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="supports_stained_glass" class="w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                <span class="ml-2 text-gray-700">Stained Glass</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="supports_other" class="w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                <span class="ml-2 text-gray-700">Other</span>
              </label>
            </div>
          </div>

          <!-- Reason for edit -->
          <div class="border-t pt-6 mt-6">
            <label for="edit_reason" class="block text-sm font-medium text-gray-700 mb-2">
              Reason for Edit <span class="text-red-500">*</span>
            </label>
            <textarea
              id="edit_reason"
              name="edit_reason"
              rows="3"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              placeholder="Briefly explain what changes you're making and why..."
            ></textarea>
          </div>

          <!-- Submitter Info -->
          <div class="border-t pt-6 mt-6">
            <h3 class="text-lg font-medium mb-4">Your Information (Optional)</h3>
            <p class="text-sm text-gray-600 mb-4">
              We won't share your information. It's just so we can follow up if needed.
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="submitter_name" class="block text-sm font-medium text-gray-700 mb-2">
                  Your Name
                </label>
                <input
                  type="text"
                  id="submitter_name"
                  name="submitter_name"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                />
              </div>

              <div>
                <label for="submitter_email" class="block text-sm font-medium text-gray-700 mb-2">
                  Your Email
                </label>
                <input
                  type="email"
                  id="submitter_email"
                  name="submitter_email"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                />
              </div>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="pt-6">
            <button
              type="submit"
              class="w-full bg-orange-500 text-white py-3 px-6 rounded-lg font-bold text-lg hover:bg-orange-600 transition disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Submit Edit Suggestion
            </button>
          </div>

          <!-- Success/Error Messages -->
          <div id="formMessage" class="hidden p-4 rounded-lg"></div>
        </form>
      </div>

      <!-- Back Link -->
      <div class="text-center mt-8">
        <a href="/" class="text-orange-500 hover:text-orange-600 font-medium">
          ← Back to Home
        </a>
      </div>
    </div>
  </section>
</Layout>

<script>
  const searchInput = document.getElementById('storeSearch') as HTMLInputElement;
  const searchResults = document.getElementById('searchResults') as HTMLDivElement;
  const editFormContainer = document.getElementById('editFormContainer') as HTMLDivElement;
  const form = document.getElementById('editSuggestionForm') as HTMLFormElement;
  const messageDiv = document.getElementById('formMessage') as HTMLDivElement;

  let allStores: any[] = [];
  let selectedStore: any = null;

  // Load stores
  async function loadStores() {
    try {
      const response = await fetch('/stores.json');
      allStores = await response.json();
    } catch (error) {
      console.error('Failed to load stores:', error);
    }
  }

  // Search stores
  searchInput?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value.toLowerCase().trim();

    if (query.length < 2) {
      searchResults.classList.add('hidden');
      return;
    }

    const matches = allStores.filter(store =>
      store.name.toLowerCase().includes(query) ||
      store.city?.toLowerCase().includes(query) ||
      store.state?.toLowerCase().includes(query)
    ).slice(0, 10);

    if (matches.length > 0) {
      searchResults.innerHTML = matches.map(store => `
        <button
          type="button"
          class="w-full text-left px-4 py-3 hover:bg-gray-100 rounded-lg border border-gray-200"
          data-store='${JSON.stringify(store)}'
        >
          <div class="font-medium">${store.name}</div>
          <div class="text-sm text-gray-600">${store.city || ''}, ${store.state || ''}</div>
        </button>
      `).join('');

      // Add click handlers
      searchResults.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedStore = JSON.parse(btn.getAttribute('data-store') || '{}');
          populateForm(selectedStore);
          searchResults.classList.add('hidden');
          editFormContainer.classList.remove('hidden');
        });
      });

      searchResults.classList.remove('hidden');
    } else {
      searchResults.innerHTML = '<div class="px-4 py-3 text-gray-500">No stores found</div>';
      searchResults.classList.remove('hidden');
    }
  });

  // Populate form with store data
  function populateForm(store: any) {
    (document.getElementById('store_stable_id') as HTMLInputElement).value = store.stable_id;
    (document.getElementById('original_name') as HTMLInputElement).value = store.name;
    (document.getElementById('name') as HTMLInputElement).value = store.name;
    (document.getElementById('website_url') as HTMLInputElement).value = store.website_url || '';
    (document.getElementById('address_line1') as HTMLInputElement).value = store.address_line1 || '';
    (document.getElementById('address_line2') as HTMLInputElement).value = store.address_line2 || '';
    (document.getElementById('city') as HTMLInputElement).value = store.city || '';
    (document.getElementById('state') as HTMLInputElement).value = store.state || '';
    (document.getElementById('zip') as HTMLInputElement).value = store.zip || '';
    (document.getElementById('phone') as HTMLInputElement).value = store.phone || '';
    (document.getElementById('notes') as HTMLTextAreaElement).value = store.notes || '';

    // Populate technique checkboxes
    const techniqueFields = [
      'supports_casting',
      'supports_flameworking_hard',
      'supports_flameworking_soft',
      'supports_fusing',
      'supports_glass_blowing',
      'supports_stained_glass',
      'supports_other'
    ];
    techniqueFields.forEach(field => {
      const checkbox = document.querySelector(`input[name="${field}"]`) as HTMLInputElement;
      if (checkbox) {
        checkbox.checked = store[field] || false;
      }
    });
  }

  // Handle form submission
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Handle checkboxes explicitly
    const techniqueFields = [
      'supports_casting',
      'supports_flameworking_hard',
      'supports_flameworking_soft',
      'supports_fusing',
      'supports_glass_blowing',
      'supports_stained_glass',
      'supports_other'
    ];
    techniqueFields.forEach(field => {
      data[field] = formData.has(field);
    });

    // Disable submit button
    const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    submitButton.disabled = true;
    submitButton.textContent = 'Submitting...';

    try {
      const response = await fetch('/api/suggest-edit', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (response.ok) {
        // Success
        messageDiv.className = 'p-4 rounded-lg bg-green-50 border border-green-200 text-green-800';
        messageDiv.textContent = result.message || 'Thank you! Your edit suggestion has been submitted for review.';
        messageDiv.classList.remove('hidden');

        // Reset form
        form.reset();
        editFormContainer.classList.add('hidden');
        searchInput.value = '';
        selectedStore = null;
      } else {
        // Error
        messageDiv.className = 'p-4 rounded-lg bg-red-50 border border-red-200 text-red-800';
        messageDiv.textContent = result.error || 'Something went wrong. Please try again.';
        messageDiv.classList.remove('hidden');
      }
    } catch (error) {
      messageDiv.className = 'p-4 rounded-lg bg-red-50 border border-red-200 text-red-800';
      messageDiv.textContent = 'Network error. Please check your connection and try again.';
      messageDiv.classList.remove('hidden');
    } finally {
      // Re-enable submit button
      submitButton.disabled = false;
      submitButton.textContent = 'Submit Edit Suggestion';

      // Scroll to message
      messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  });

  // Load stores on page load
  loadStores();
</script>
</Layout>
