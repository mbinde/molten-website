---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Import Tool - Molten" description="Import your glass inventory into Molten">
  <!-- Hero Section -->
  <section class="gradient-orange text-white py-16">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h1 class="text-5xl md:text-6xl font-bold mb-6">
        Inventory Import Tool
      </h1>
      <p class="text-xl text-white/90">
        Build your inventory list here, then import it into Molten
      </p>
    </div>
  </section>

  <!-- Main Content -->
  <section class="py-12 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

      <!-- Instructions -->
      <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
        <h2 class="text-2xl font-bold mb-4">How it works</h2>
        <ol class="list-decimal list-inside space-y-2 text-gray-700">
          <li>Search for glass items in the catalog below</li>
          <li>Click "Add to Import List" for items you own</li>
          <li>Specify quantities for each item in your cart</li>
          <li>Click "Export JSON" to download your inventory file</li>
          <li>Open the file in Molten on your iPhone to import</li>
        </ol>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Left Column: Catalog Browser -->
        <div class="lg:col-span-2">
          <div class="bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-2xl font-bold mb-4">Browse Glass Catalog</h2>

            <!-- Search and Filters -->
            <div class="space-y-4 mb-6">
              <input
                type="text"
                id="searchInput"
                placeholder="Search by name, code, or manufacturer..."
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              />

              <div class="flex gap-4 flex-wrap">
                <select id="coeFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                  <option value="">All COE</option>
                  <option value="33">COE 33</option>
                  <option value="90">COE 90</option>
                  <option value="96">COE 96</option>
                  <option value="104">COE 104</option>
                </select>

                <select id="manufacturerFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                  <option value="">All Manufacturers</option>
                </select>
              </div>
            </div>

            <!-- Results Count -->
            <div class="text-sm text-gray-600 mb-4">
              Showing <span id="resultCount">0</span> items
            </div>

            <!-- Catalog Items List -->
            <div id="catalogList" class="space-y-3 max-h-[600px] overflow-y-auto">
              <div class="text-center text-gray-500 py-8">Loading catalog...</div>
            </div>
          </div>
        </div>

        <!-- Right Column: Import Cart -->
        <div class="lg:col-span-1">
          <div class="bg-white rounded-lg shadow-sm p-6 sticky top-4">
            <h2 class="text-2xl font-bold mb-4">Import List</h2>

            <div id="importCart" class="space-y-3 mb-6 max-h-[400px] overflow-y-auto">
              <div class="text-center text-gray-400 py-8 text-sm">
                No items added yet
              </div>
            </div>

            <div class="border-t pt-4">
              <div class="text-lg font-semibold mb-4">
                Total: <span id="cartCount">0</span> items
              </div>

              <button
                id="exportBtn"
                disabled
                class="w-full gradient-orange text-white px-6 py-3 rounded-lg font-bold hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Export JSON
              </button>

              <button
                id="clearBtn"
                class="w-full mt-2 bg-gray-100 text-gray-700 px-6 py-2 rounded-lg font-medium hover:bg-gray-200 transition"
              >
                Clear All
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    // State
    let catalog = [];
    let filteredCatalog = [];
    let importList = [];

    // Load catalog
    async function loadCatalog() {
      try {
        const response = await fetch('/glassitems.json');
        const data = await response.json();
        catalog = data.glassitems;
        filteredCatalog = [...catalog];

        // Populate manufacturer filter
        const manufacturers = [...new Set(catalog.map(item => item.manufacturer))].sort();
        const mfgFilter = document.getElementById('manufacturerFilter');
        manufacturers.forEach(mfg => {
          const option = document.createElement('option');
          option.value = mfg;
          option.textContent = mfg;
          mfgFilter.appendChild(option);
        });

        renderCatalog();
      } catch (error) {
        console.error('Error loading catalog:', error);
        document.getElementById('catalogList').innerHTML =
          '<div class="text-center text-red-500 py-8">Error loading catalog</div>';
      }
    }

    // Filter catalog
    function filterCatalog() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const coeFilter = document.getElementById('coeFilter').value;
      const mfgFilter = document.getElementById('manufacturerFilter').value;

      filteredCatalog = catalog.filter(item => {
        const matchesSearch = !searchTerm ||
          item.name.toLowerCase().includes(searchTerm) ||
          item.code.toLowerCase().includes(searchTerm) ||
          item.manufacturer.toLowerCase().includes(searchTerm);

        const matchesCOE = !coeFilter || item.coe === coeFilter;
        const matchesMfg = !mfgFilter || item.manufacturer === mfgFilter;

        return matchesSearch && matchesCOE && matchesMfg;
      });

      renderCatalog();
    }

    // Render catalog
    function renderCatalog() {
      const container = document.getElementById('catalogList');
      const resultCount = document.getElementById('resultCount');

      resultCount.textContent = filteredCatalog.length;

      if (filteredCatalog.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-400 py-8">No items found</div>';
        return;
      }

      container.innerHTML = filteredCatalog.slice(0, 50).map(item => `
        <div class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
          ${item.image_url ? `
            <img src="${item.image_url}" alt="${item.name}" class="w-12 h-12 rounded object-cover" />
          ` : `
            <div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-500">
              No img
            </div>
          `}
          <div class="flex-1 min-w-0">
            <div class="font-semibold text-gray-900 truncate">${item.name}</div>
            <div class="text-sm text-gray-500">${item.manufacturer} - ${item.code}</div>
            <div class="text-xs text-gray-400">COE ${item.coe}</div>
          </div>
          <button
            onclick="addToCart('${item.code}')"
            class="px-4 py-2 bg-orange-500 text-white rounded-lg text-sm font-medium hover:bg-orange-600 transition flex-shrink-0"
          >
            Add
          </button>
        </div>
      `).join('');

      if (filteredCatalog.length > 50) {
        container.innerHTML += `
          <div class="text-center text-sm text-gray-500 py-4">
            Showing first 50 of ${filteredCatalog.length} results. Refine your search to see more.
          </div>
        `;
      }
    }

    // Add to cart
    function addToCart(code) {
      const item = catalog.find(i => i.code === code);
      if (!item) return;

      // Check if already in cart
      if (importList.find(i => i.code === code)) {
        alert('Item already in import list');
        return;
      }

      importList.push({
        ...item,
        quantity: 1
      });

      renderCart();
    }

    // Remove from cart
    function removeFromCart(code) {
      importList = importList.filter(i => i.code !== code);
      renderCart();
    }

    // Update quantity
    function updateQuantity(code, quantity) {
      const item = importList.find(i => i.code === code);
      if (item) {
        item.quantity = Math.max(1, parseInt(quantity) || 1);
        renderCart();
      }
    }

    // Render cart
    function renderCart() {
      const container = document.getElementById('importCart');
      const cartCount = document.getElementById('cartCount');
      const exportBtn = document.getElementById('exportBtn');

      cartCount.textContent = importList.length;
      exportBtn.disabled = importList.length === 0;

      if (importList.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-400 py-8 text-sm">
            No items added yet
          </div>
        `;
        return;
      }

      container.innerHTML = importList.map(item => `
        <div class="p-3 border border-gray-200 rounded-lg">
          <div class="flex justify-between items-start mb-2">
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-sm text-gray-900 truncate">${item.name}</div>
              <div class="text-xs text-gray-500">${item.manufacturer} - COE ${item.coe}</div>
            </div>
            <button
              onclick="removeFromCart('${item.code}')"
              class="text-red-500 hover:text-red-700 ml-2"
            >
              âœ•
            </button>
          </div>
          <input
            type="number"
            min="1"
            value="${item.quantity}"
            onchange="updateQuantity('${item.code}', this.value)"
            class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-orange-500"
            placeholder="Quantity"
          />
        </div>
      `).join('');
    }

    // Export JSON
    function exportJSON() {
      if (importList.length === 0) return;

      const exportData = {
        version: "1.0",
        generated: new Date().toISOString(),
        items: importList.map(item => ({
          code: item.code,
          name: item.name,
          manufacturer: item.manufacturer,
          coe: item.coe,
          quantity: item.quantity
        }))
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `molten-import-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Clear cart
    function clearCart() {
      if (importList.length === 0) return;
      if (confirm('Clear all items from import list?')) {
        importList = [];
        renderCart();
      }
    }

    // Make functions global
    window.addToCart = addToCart;
    window.removeFromCart = removeFromCart;
    window.updateQuantity = updateQuantity;

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', filterCatalog);
    document.getElementById('coeFilter').addEventListener('change', filterCatalog);
    document.getElementById('manufacturerFilter').addEventListener('change', filterCatalog);
    document.getElementById('exportBtn').addEventListener('click', exportJSON);
    document.getElementById('clearBtn').addEventListener('click', clearCart);

    // Initialize
    loadCatalog();
  </script>
</Layout>
